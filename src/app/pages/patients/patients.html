<div class="mb-8 flex flex-col items-center">
  <h1 class="text-4xl lg:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-cyan-500 mb-2 tracking-tight">
    Patients Directory
  </h1>
  <p class="text-surface-500 dark:text-surface-400 text-lg font-medium">Manage and view all registered patients</p>
</div>

<div class="card mb-5">
  <!-- Filters -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
    <p-iconfield iconPosition="left" class="w-full">
      <p-inputicon styleClass="pi pi-search" />
      <input pInputText type="text" [ngModel]="searchValue()" (input)="onSearch($any($event.target).value)" placeholder="Search by name..." class="w-full" />
    </p-iconfield>
    
    <p-select 
      [options]="cities()" 
      [(ngModel)]="selectedCity" 
      optionLabel="name" 
      placeholder="Select City" 
      (onChange)="reloadTable(dt)"
      [showClear]="true"
      styleClass="w-full"
      [filter]="true"
      filterBy="name">
    </p-select>

    <p-select 
      [options]="genderOptions" 
      [(ngModel)]="selectedGender" 
      optionLabel="label" 
      optionValue="value"
      placeholder="Select Gender" 
      (onChange)="reloadTable(dt)"
      [showClear]="true"
      styleClass="w-full">
    </p-select>

    <p-select 
      [options]="emailConfirmedOptions" 
      [(ngModel)]="selectedEmailConfirmed" 
      optionLabel="label" 
      optionValue="value"
      placeholder="Email Confirmed" 
      (onChange)="reloadTable(dt)"
      [showClear]="true"
      styleClass="w-full">
    </p-select>
  </div>

  <!-- Custom Sort -->
  <div class="flex flex-col md:flex-row gap-4 mb-4 items-center">
    <p-select 
      [options]="sortOptions" 
      [(ngModel)]="selectedSortField" 
      optionLabel="label" 
      optionValue="value"
      placeholder="Sort By" 
      [showClear]="true"
      styleClass="w-full md:w-60">
    </p-select>

    <div class="flex items-center gap-2">
      <span class="text-sm font-medium">Desc</span>
      <p-toggleswitch [(ngModel)]="sortDescending"></p-toggleswitch>
    </div>

    <p-button label="Add" icon="pi pi-plus" (click)="addSort()" [disabled]="!selectedSortField()"></p-button>
    <p-button label="Apply" icon="pi pi-check" (click)="applySort()" severity="success"></p-button>
    <p-button label="Clear" icon="pi pi-times" (click)="clearSorts()" severity="secondary" [disabled]="activeSorts().length === 0"></p-button>
  </div>

  <!-- Active Sorts -->
  <div class="flex flex-wrap gap-2 mb-4" *ngIf="activeSorts().length > 0">
    <p-chip 
      *ngFor="let sort of activeSorts()" 
      [label]="sort.label + (sort.desc ? ' (Desc)' : ' (Asc)')" 
      [removable]="true" 
      (onRemove)="removeSort(sort.field)">
    </p-chip>
  </div>

  <p-table
    #dt
    [value]="patients()"
    [paginator]="true"
    [rows]="10"
    [lazy]="true"
    (onLazyLoad)="loadPatients($event)"
    [totalRecords]="totalRecords()"
    [loading]="loading()"
    [showCurrentPageReport]="true"
    [tableStyle]="{ 'min-width': '50rem' }"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
    [rowsPerPageOptions]="[10, 20, 50]"
    styleClass="p-datatable-gridlines border border-surface-200 dark:border-surface-700 rounded-xl overflow-hidden shadow-sm"
    paginatorDropdownAppendTo="body"
  >
    <ng-template pTemplate="header">
      <tr>
        <th style="width:10%" class="bg-blue-50 dark:bg-blue-900/20 border-b border-blue-100 dark:border-blue-900/30 font-semibold text-blue-900 dark:text-blue-100">Avatar</th>
        <th style="width:20%" class="bg-blue-50 dark:bg-blue-900/20 border-b border-blue-100 dark:border-blue-900/30 font-semibold text-blue-900 dark:text-blue-100">Name</th>
        <th style="width:15%" class="bg-blue-50 dark:bg-blue-900/20 border-b border-blue-100 dark:border-blue-900/30 font-semibold text-blue-900 dark:text-blue-100">Gender</th>
        <th style="width:15%" class="bg-blue-50 dark:bg-blue-900/20 border-b border-blue-100 dark:border-blue-900/30 font-semibold text-blue-900 dark:text-blue-100">DOB</th>
        <th style="width:20%" class="bg-blue-50 dark:bg-blue-900/20 border-b border-blue-100 dark:border-blue-900/30 font-semibold text-blue-900 dark:text-blue-100">City</th>
        <th style="width:20%" class="bg-blue-50 dark:bg-blue-900/20 border-b border-blue-100 dark:border-blue-900/30 font-semibold text-blue-900 dark:text-blue-100">Actions</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-patient>
      <tr class="border-b border-surface-100 dark:border-surface-800">
        <td>
          <img [src]="patient.avatarUrl ? patient.avatarUrl : '/person.png'" alt="Avatar" class="w-10 h-10 rounded-full object-cover" />
        </td>
        <td>{{ patient.name }}</td>
        <td>{{ patient.gender === Gender.Male ? 'Male' : patient.gender === Gender.Female ? 'Female' : 'Unknown' }}</td>
        <td>{{ patient.dateOfBirth | date }}</td>
        <td>{{ patient.city }}</td>
        <td>
          <div class="flex gap-2">
            <p-button icon="pi pi-eye" [rounded]="true" [text]="true" severity="info"></p-button>
            <p-button icon="pi pi-trash" [rounded]="true" [text]="true" severity="danger" (onClick)="deletePatient($event, patient)"></p-button>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>

<p-confirmDialog></p-confirmDialog>
<p-toast></p-toast>
